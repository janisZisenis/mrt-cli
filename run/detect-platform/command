#!/usr/bin/env bash

set -e

rootDir=$1
shift
# shellcheck source=./../../packaged-scripts/detection-functions.sh
. "$rootDir/packaged-scripts/detection-functions.sh"

ARCH_FLAG="--arch"
OS_FLAG="--os"

help(){
  printf "Usage:"
  printf 'options:\n'
  printf -- "-h, --help\tShow this help message\n"
  printf -- '%s|%s\tPrints out os or arch. If none prints out platform (eg. %s)\n' "$OS_FLAG" "$ARCH_FLAG" "$(detect_os)/$(detect_arch)"
}

while [ "$#" -gt 0 ]; do
  case $1 in
    --help|-h)
      help;
      exit 1
      ;;
    "$ARCH_FLAG"|"$OS_FLAG")
      if [[ -z ${shortStrategy+x} ]]
        then
          flag="$1"
          shortStrategy=${flag//--/}
        else
          echo "Either specify $ARCH_FLAG or $OS_FLAG, not both"
          exit 1
      fi
      shift;;
    *)
      echo "$1 is an invalid option";
      exit 1
      ;;
  esac
done

if [[ $shortStrategy == "${ARCH_FLAG//--/}" ]]
then
  detect_arch
  exit 0
fi

if [[ $shortStrategy == "${OS_FLAG//--/}" ]]
then
  detect_os
  exit 0
fi

echo "$(detect_os)/$(detect_arch)"