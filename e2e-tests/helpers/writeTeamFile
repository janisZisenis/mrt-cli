#!/usr/bin/env bash

teamFileName() {
	echo "team.json"
}

getTestingRepositoryUrl() {
	local repositoryName="$1"

	echo "git@github-testing:janisZisenisTesting/$repositoryName.git"
}

getRepositoryUrls() {
	local repositoryNames=("$@")

	for r in "${repositoryNames[@]}"; do
		getTestingRepositoryUrl "$r"
	done
}

writeBlockedBranches() {
	local blockedBranches=("$@")

	createTeamFileIfNotExisting

	local concatenation=""
	for b in "${blockedBranches[@]}"; do
		concatenation="$concatenation\"$b\","
	done

	if [[ ${#blockedBranches[*]} -gt 0 ]]; then
		concatenation=${concatenation::-1}
	fi

	local jsonArray="[$concatenation]"

	local string
	string=$(jq --argjson jsonArray "$jsonArray" '. += {"blockedBranches": ($jsonArray)}' "$(testEnvDir)/$(teamFileName)")
	echo "$string" >"$(testEnvDir)/$(teamFileName)"
}

writeRepositoriesUrls() {
	local repositoriesUrls=("$@")

	createTeamFileIfNotExisting

	local string=""
	for r in "${repositoriesUrls[@]}"; do
		string="$string\"$r\","
	done

	if [[ ${#repositoriesUrls[@]} -gt 0 ]]; then
		string=${string::-1}
	fi

	local jsonArray="[$string]"

	local string
	string=$(jq --argjson jsonArray "$jsonArray" '. += {"repositories": ($jsonArray)}' "$(testEnvDir)/$(teamFileName)")
	echo "$string" >"$(testEnvDir)/$(teamFileName)"
}

writeRepositoriesPrefixes() {
	local repositoriesPrefixes=("$@")

	createTeamFileIfNotExisting

	local concatenation=""
	for p in "${repositoriesPrefixes[@]}"; do
		concatenation="$concatenation\"$p\","
	done

	if [[ ${#repositoriesPrefixes[*]} -gt 0 ]]; then
		concatenation=${concatenation::-1}
	fi

	local jsonArray="[$concatenation]"

	local string
	string=$(jq --argjson jsonArray "$jsonArray" '. += {"repositoriesPrefixes": ($jsonArray)}' "$(testEnvDir)/$(teamFileName)")
	echo "$string" >"$(testEnvDir)/$(teamFileName)"
}

writeRepositoriesPath() {
	local repositoriesPath="$1"

	createTeamFileIfNotExisting

	local string
	string=$(jq --arg repositoriesPath "$repositoriesPath" '. += {"repositoriesPath": ($repositoriesPath)}' "$(testEnvDir)/$(teamFileName)")
	echo "$string" >"$(testEnvDir)/$(teamFileName)"
}

writeCommitPrefixRegex() {
	local prefix="$1"

	createTeamFileIfNotExisting

	local string
	string=$(jq --arg prefix "$prefix" '. += {"commitPrefixRegex": ($prefix)}' "$(testEnvDir)/$(teamFileName)")
	echo "$string" >"$(testEnvDir)/$(teamFileName)"
}

createTeamFileIfNotExisting() {
	if [[ ! -f "$(testEnvDir)/$(teamFileName)" ]]; then
		echo "{}" >"$(testEnvDir)/$(teamFileName)"
	fi
}
