#!/bin/bash

_testEnvDir() {
  echo "./testEnv/$(uuidgen)"
}

_common_setup() {
  load '3rdParty/test_helper/bats-support/load'
  load '3rdParty/test_helper/bats-assert/load'

  testEnvironmentDir=$(_testEnvDir)

  PROJECT_ROOT="$( cd "$( dirname "$BATS_TEST_FILENAME" )/.." >/dev/null 2>&1 && pwd )"
  BUILD_PATH="$PROJECT_ROOT/build"
  PACKAGE_NAME="mrt-multiplatform.tar.gz"
  EXTRACTED_PATH="$testEnvironmentDir/extracted"

  mkdir -p "$testEnvironmentDir"
  mkdir -p "$EXTRACTED_PATH"

  cp "$BUILD_PATH/$PACKAGE_NAME" "$testEnvironmentDir"/$PACKAGE_NAME
  tar -xvzf "$testEnvironmentDir/$PACKAGE_NAME" -C "$EXTRACTED_PATH"
  "$EXTRACTED_PATH/setup.sh"

  eval "$(ssh-agent)"
}

_common_teardown() {
  rm -rf "$testEnvironmentDir"
}