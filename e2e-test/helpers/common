#!/usr/bin/env bash
HELPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
load "$HELPER_DIR/../3rdParty/test_helper/bats-support/load"
load "$HELPER_DIR/../3rdParty/test_helper/bats-assert/load"
load "$HELPER_DIR/absolutePath"

_testEnvDir="testEnv/$(uuidgen)"
testEnvDir() {
	echo "$_testEnvDir"
}

_testEnvBinDir() {
	echo "$_testEnvDir/bin"
}

_exeName() {
	echo "mrt-bin"
}

_pathToBinary() {
	mrt --team-dir "$(pwd)" run binary-location
}

_testEnvExePath() {
	echo "$(_testEnvBinDir)/$(_exeName)"
}

_setup_binary() {
	mkdir -p "$(_testEnvBinDir)"
	cp "$(_pathToBinary)" "$(_testEnvExePath)"
	chmod +x "$(_testEnvExePath)"
	PATH="$PATH:$(absolutePath "$(_testEnvBinDir)")"
}

common_setup() {
	_setup_binary

	eval "$(ssh-agent -s 3>&-)"
}

common_teardown() {
	rm -rf "$(testEnvDir)"
	eval "$(ssh-agent -k)"
}

execute() {
	"$(_exeName)" --team-dir "$(testEnvDir)" "$@"
}

runCommand() {
	execute run "$@"
}
