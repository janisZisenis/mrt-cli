#!/usr/bin/env bash

_testEnvDir="testEnv/$(uuidgen)"
testEnvDir() {
  echo "$_testEnvDir"
}

exeName() {
  echo "mrt-bin"
}

_common_setup() {
  local HELPER_DIR
  HELPER_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
	load "$HELPER_DIR/../3rdParty/test_helper/bats-support/load"
	load "$HELPER_DIR/../3rdParty/test_helper/bats-assert/load"
	load "$HELPER_DIR/absolutePath"

	local projectRoot
	projectRoot=$(pwd)

	local testEnvBinDir
	testEnvBinDir="$(testEnvDir)/bin"

	mkdir -p "$testEnvBinDir"
	local pathToBinary
	pathToBinary="$(mrt --team-dir "$projectRoot" run binary-location)"
	cp "$pathToBinary" "$testEnvBinDir/$(exeName)"

	chmod +x "$testEnvBinDir/$(exeName)"

	PATH="$PATH:$(absolutePath "$testEnvBinDir")"

	eval "$(ssh-agent -s 3>&-)"
}

_common_teardown() {
	rm -rf "$(testEnvDir)"
	eval "$(ssh-agent -k)"
}

execute() {
	"$(exeName)" --team-dir "$(testEnvDir)" "$@"
}

runCommand() {
	execute run "$@"
}